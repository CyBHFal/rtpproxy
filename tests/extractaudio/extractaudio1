#!/bin/sh

# checksum tests to verify that captured audio is correct.

BASEDIR="`dirname "${0}"`/.."
. "${BASEDIR}/functions"

TKINDS="mono stereo"
OFMTS_mono="wav raw w64"
OFMTS_stereo="wav w64"

ofiles=""
extractaudio_RFILES1="call1_alaw call1_ulaw call1_g722 call1_g729 call1_gsm \
 call1_g722_srtp corrupted_g722"
for f in ${extractaudio_RFILES1}
do
  extractaudio_RFILES="extractaudio/${f} ${extractaudio_RFILES}"
done
extractaudio_RFILES="${extractaudio_RFILES} acct_rtcp_hep/rtcp"

for tkind in ${TKINDS}
do
  if [ ${tkind} = "mono" ]
  then
    EXTRACTAUDIO_ARGS=""
    OFMTS="${OFMTS_mono}"
    CHFMT="m"
  else
    EXTRACTAUDIO_ARGS="-s"
    OFMTS="${OFMTS_stereo}"
    CHFMT="s"
  fi
  for rfile in ${extractaudio_RFILES}
  do
    bfile="`basename ${rfile}`"
    ofile="extractaudio/${bfile}.output"
    for ofmt in ${OFMTS}
    do
      DFMTS=`cat extractaudio/extractaudio.${CHFMT}.${ofmt}.dfmts`
      for dfmt in ${DFMTS}
      do
        wfile="${bfile}.${tkind}.${dfmt}.${ofmt}"
        sfile="${bfile}.${tkind}.${dfmt}.${ofmt}.tout"
        logfile="${bfile}.${tkind}.${dfmt}.${ofmt}.rlog"
        if [ -e "${wfile}" ]
        then
          rm "${wfile}"
        fi
        afile="extractaudio/${bfile}.args"
        if [ -e "${afile}" ]
        then
          EXTRACTAUDIO_EARGS=`"${afile}" "${rfile}"`
        else
          EXTRACTAUDIO_EARGS="${rfile}"
        fi
        ${EXTRACTAUDIO} -F ${ofmt} -D ${dfmt} ${EXTRACTAUDIO_ARGS} \
         ${EXTRACTAUDIO_EARGS} ${wfile} 2>${logfile} >${sfile}
        report "${EXTRACTAUDIO} ${rfile}"
        test -s ${wfile}
        report "${rfile} -> ${wfile}"
        sha256_verify ${wfile} extractaudio/extractaudio.checksums
        ${DIFF} "${ofile}" "${sfile}"
        report "checking RTP stats for the ${rfile}"
      done
    done
  done
done
